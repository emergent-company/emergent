name: Emergent CLI & Release

on:
  push:
    branches: [master, main]
    paths:
      - 'tools/emergent-cli/**'
      - '.github/workflows/emergent-cli.yml'
      - 'VERSION'
    tags:
      - 'v*'
  pull_request:
    branches: [master, main]
    paths:
      - 'tools/emergent-cli/**'
      - '.github/workflows/emergent-cli.yml'
      - 'VERSION'
  workflow_dispatch:

env:
  GO_VERSION: '1.24'

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    if: "!startsWith(github.ref, 'refs/tags/')"
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache-dependency-path: tools/emergent-cli/go.sum

      - name: golangci-lint
        uses: golangci/golangci-lint-action@v6
        with:
          version: latest
          working-directory: tools/emergent-cli

  test:
    name: Test
    runs-on: ubuntu-latest
    if: "!startsWith(github.ref, 'refs/tags/')"
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache-dependency-path: tools/emergent-cli/go.sum

      - name: Run tests
        working-directory: tools/emergent-cli
        env:
          GOWORK: off
        run: go test -v -race -coverprofile=coverage.out -covermode=atomic ./...

      - name: Upload coverage
        uses: codecov/codecov-action@v4
        with:
          files: tools/emergent-cli/coverage.out
          flags: emergent-cli
          fail_ci_if_error: false

  build:
    name: Build (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    needs: [lint, test]
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        include:
          - os: ubuntu-latest
            goos: linux
            goarch: amd64
            ext: ''
          - os: windows-latest
            goos: windows
            goarch: amd64
            ext: '.exe'
          - os: macos-latest
            goos: darwin
            goarch: amd64
            ext: ''
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache-dependency-path: tools/emergent-cli/go.sum

      - name: Get version info
        id: version
        shell: bash
        run: |
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            VERSION="${{ github.ref_name }}"
          else
            VERSION=$(git describe --tags --always 2>/dev/null || echo "dev")
          fi
          VERSION="${VERSION#v}"
          COMMIT=$(git rev-parse --short HEAD)
          BUILD_TIME=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "commit=$COMMIT" >> $GITHUB_OUTPUT
          echo "build_time=$BUILD_TIME" >> $GITHUB_OUTPUT

      - name: Build binary
        working-directory: tools/emergent-cli
        shell: bash
        env:
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
          CGO_ENABLED: 0
        run: |
          go build \
            -ldflags="-s -w -X github.com/emergent-company/emergent/tools/emergent-cli/internal/cmd.Version=${{ steps.version.outputs.version }} -X github.com/emergent-company/emergent/tools/emergent-cli/internal/cmd.Commit=${{ steps.version.outputs.commit }} -X github.com/emergent-company/emergent/tools/emergent-cli/internal/cmd.BuildDate=${{ steps.version.outputs.build_time }}" \
            -o dist/emergent-cli-${{ matrix.goos }}-${{ matrix.goarch }}${{ matrix.ext }} \
            ./cmd

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: emergent-cli-${{ matrix.goos }}-${{ matrix.goarch }}
          path: tools/emergent-cli/dist/emergent-cli-*
          retention-days: 7

  build-cross:
    name: Build Cross-Platform Binaries
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    strategy:
      matrix:
        include:
          # Linux
          - goos: linux
            goarch: amd64
          - goos: linux
            goarch: arm64
          - goos: linux
            goarch: arm
          # macOS
          - goos: darwin
            goarch: amd64
          - goos: darwin
            goarch: arm64
          # Windows
          - goos: windows
            goarch: amd64
          - goos: windows
            goarch: arm64
          # FreeBSD
          - goos: freebsd
            goarch: amd64
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache-dependency-path: tools/emergent-cli/go.sum

      - name: Get version info
        id: version
        run: |
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            VERSION="${{ github.ref_name }}"
          else
            VERSION=$(git describe --tags --always 2>/dev/null || echo "dev")
          fi
          VERSION="${VERSION#v}"
          COMMIT=$(git rev-parse --short HEAD)
          BUILD_TIME=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "commit=$COMMIT" >> $GITHUB_OUTPUT
          echo "build_time=$BUILD_TIME" >> $GITHUB_OUTPUT

      - name: Build binary
        working-directory: tools/emergent-cli
        env:
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
          CGO_ENABLED: 0
        run: |
          EXT=""
          if [ "${{ matrix.goos }}" = "windows" ]; then
            EXT=".exe"
          fi

          go build \
            -ldflags="-s -w -X github.com/emergent-company/emergent/tools/emergent-cli/internal/cmd.Version=${{ steps.version.outputs.version }} -X github.com/emergent-company/emergent/tools/emergent-cli/internal/cmd.Commit=${{ steps.version.outputs.commit }} -X github.com/emergent-company/emergent/tools/emergent-cli/internal/cmd.BuildDate=${{ steps.version.outputs.build_time }}" \
            -o dist/emergent-cli-${{ matrix.goos }}-${{ matrix.goarch }}${EXT} \
            ./cmd

      - name: Create archive
        working-directory: tools/emergent-cli/dist
        run: |
          if [ "${{ matrix.goos }}" = "windows" ]; then
            zip emergent-cli-${{ matrix.goos }}-${{ matrix.goarch }}.zip emergent-cli-${{ matrix.goos }}-${{ matrix.goarch }}.exe
          else
            tar czf emergent-cli-${{ matrix.goos }}-${{ matrix.goarch }}.tar.gz emergent-cli-${{ matrix.goos }}-${{ matrix.goarch }}
          fi

      - name: Upload release artifact
        uses: actions/upload-artifact@v4
        with:
          name: release-${{ matrix.goos }}-${{ matrix.goarch }}
          path: |
            tools/emergent-cli/dist/*.tar.gz
            tools/emergent-cli/dist/*.zip
          retention-days: 90

  release:
    name: Create Unified GitHub Release
    runs-on: ubuntu-latest
    needs: [build-cross]
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: release-*
          path: release-artifacts
          merge-multiple: true

      - name: Generate checksums
        working-directory: release-artifacts
        run: |
          sha256sum * > checksums.txt
          cat checksums.txt

      - name: Extract version
        id: version
        run: echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Get previous tag
        id: prev_tag
        run: |
          PREV_TAG=$(git tag --sort=-version:refname | grep "^v" | head -2 | tail -1 || echo "")
          if [ -z "$PREV_TAG" ] || [ "$PREV_TAG" = "${{ github.ref_name }}" ]; then
            PREV_TAG=$(git rev-list --max-parents=0 HEAD | head -1)
          fi
          echo "tag=$PREV_TAG" >> $GITHUB_OUTPUT
          echo "Previous tag: $PREV_TAG"

      - name: Get commit messages for changelog
        id: commits
        run: |
          echo "commits<<EOF" >> $GITHUB_OUTPUT
          git log ${{ steps.prev_tag.outputs.tag }}..${{ github.ref_name }} --pretty=format:"- %s (%h)" >> $GITHUB_OUTPUT || echo "- Initial release" >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Generate changelog
        id: changelog
        uses: actions/github-script@v7
        with:
          script: |
            const commits = `${{ steps.commits.outputs.commits }}`;

            const lines = commits.split('\n').filter(l => l.trim());

            let features = [];
            let fixes = [];
            let other = [];

            for (const line of lines) {
              const lower = line.toLowerCase();
              if (lower.includes('feat') || lower.includes('add') || lower.includes('new')) {
                features.push(line);
              } else if (lower.includes('fix') || lower.includes('bug') || lower.includes('patch')) {
                fixes.push(line);
              } else {
                other.push(line);
              }
            }

            let changelog = '';
            if (features.length > 0) {
              changelog += '### Features\n' + features.join('\n') + '\n\n';
            }
            if (fixes.length > 0) {
              changelog += '### Bug Fixes\n' + fixes.join('\n') + '\n\n';
            }
            if (other.length > 0) {
              changelog += '### Other Changes\n' + other.join('\n') + '\n\n';
            }

            if (!changelog) {
              changelog = '### Initial Release\n\n';
            }

            core.setOutput('changelog', changelog);

      - name: Compute image owner
        id: owner
        run: echo "lc=$(echo '${{ github.repository_owner }}' | tr '[:upper:]' '[:lower:]')" >> $GITHUB_OUTPUT

      - name: Generate unified release notes
        run: |
          cat > release_notes.md << 'ENDOFNOTES'
          ## What's Changed

          ${{ steps.changelog.outputs.changelog }}

          ---

          ## Emergent CLI

          ### One-Line Install
          ```bash
          curl -fsSL https://raw.githubusercontent.com/${{ github.repository }}/main/tools/emergent-cli/install.sh | bash
          ```

          ### Manual Install

          | OS | Architecture | Download |
          |----|-------------|----------|
          | Linux | amd64 | [emergent-cli-linux-amd64.tar.gz](https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/emergent-cli-linux-amd64.tar.gz) |
          | Linux | arm64 | [emergent-cli-linux-arm64.tar.gz](https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/emergent-cli-linux-arm64.tar.gz) |
          | Linux | arm | [emergent-cli-linux-arm.tar.gz](https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/emergent-cli-linux-arm.tar.gz) |
          | macOS | Apple Silicon | [emergent-cli-darwin-arm64.tar.gz](https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/emergent-cli-darwin-arm64.tar.gz) |
          | macOS | Intel | [emergent-cli-darwin-amd64.tar.gz](https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/emergent-cli-darwin-amd64.tar.gz) |
          | Windows | amd64 | [emergent-cli-windows-amd64.zip](https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/emergent-cli-windows-amd64.zip) |
          | Windows | arm64 | [emergent-cli-windows-arm64.zip](https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/emergent-cli-windows-arm64.zip) |
          | FreeBSD | amd64 | [emergent-cli-freebsd-amd64.tar.gz](https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/emergent-cli-freebsd-amd64.tar.gz) |

          Verify downloads: `sha256sum -c checksums.txt`

          [CLI Documentation](https://github.com/${{ github.repository }}/blob/main/tools/emergent-cli/README.md)

          ---

          ## Go SDK

          ```bash
          go get github.com/emergent-company/emergent/apps/server-go/pkg/sdk@${{ github.ref_name }}
          ```

          ```go
          import "github.com/emergent-company/emergent/apps/server-go/pkg/sdk"
          ```

          [SDK Documentation](https://pkg.go.dev/github.com/emergent-company/emergent/apps/server-go/pkg/sdk@${{ github.ref_name }}) | [Examples](https://github.com/${{ github.repository }}/tree/main/apps/server-go/pkg/sdk/examples)

          ---

          ## Docker Image

          ```bash
          docker pull ghcr.io/${{ steps.owner.outputs.lc }}/emergent-server-with-cli:${{ steps.version.outputs.version }}
          ```

          Available platforms: `linux/amd64`, `linux/arm64`

          Includes: Emergent API server, CLI, migration tooling, and Swagger docs.

          [Deployment Guide](https://github.com/${{ github.repository }}/blob/main/deploy/minimal/README.md)
          ENDOFNOTES

      - name: Create release
        uses: softprops/action-gh-release@v2
        with:
          name: Emergent ${{ steps.version.outputs.version }}
          body_path: release_notes.md
          files: |
            release-artifacts/*
          draft: false
          prerelease: false
          generate_release_notes: false

  docker:
    name: Docker Build (CLI Container)
    runs-on: ubuntu-latest
    needs: [build-cross]
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      packages: write
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download Linux release artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: release-linux-*
          path: tools/emergent-cli/artifacts
          merge-multiple: true

      - name: Extract binaries for Docker
        working-directory: tools/emergent-cli
        run: |
          echo "=== Downloaded artifacts ==="
          ls -la artifacts/

          # Extract Linux amd64 binary
          tar xzf artifacts/emergent-cli-linux-amd64.tar.gz -C .

          # Extract Linux arm64 binary
          tar xzf artifacts/emergent-cli-linux-arm64.tar.gz -C .

          echo "=== Extracted binaries ==="
          ls -la emergent-cli-linux-*

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract version
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          OWNER_LC=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "commit=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
          echo "owner_lc=$OWNER_LC" >> $GITHUB_OUTPUT

      - name: Build and push Docker image (amd64)
        uses: docker/build-push-action@v5
        with:
          context: tools/emergent-cli
          file: tools/emergent-cli/Dockerfile.prebuilt
          push: true
          tags: |
            ghcr.io/${{ steps.version.outputs.owner_lc }}/emergent-cli:${{ steps.version.outputs.version }}-amd64
          build-args: |
            TARGETARCH=amd64
            VERSION=${{ steps.version.outputs.version }}
            GIT_COMMIT=${{ steps.version.outputs.commit }}
          labels: |
            org.opencontainers.image.version=${{ steps.version.outputs.version }}
            org.opencontainers.image.revision=${{ steps.version.outputs.commit }}
            org.opencontainers.image.source=https://github.com/${{ github.repository }}
            org.opencontainers.image.title=Emergent CLI
            org.opencontainers.image.description=Command-line interface for Emergent Knowledge Base
          platforms: linux/amd64

      - name: Build and push Docker image (arm64)
        uses: docker/build-push-action@v5
        with:
          context: tools/emergent-cli
          file: tools/emergent-cli/Dockerfile.prebuilt
          push: true
          tags: |
            ghcr.io/${{ steps.version.outputs.owner_lc }}/emergent-cli:${{ steps.version.outputs.version }}-arm64
          build-args: |
            TARGETARCH=arm64
            VERSION=${{ steps.version.outputs.version }}
            GIT_COMMIT=${{ steps.version.outputs.commit }}
          labels: |
            org.opencontainers.image.version=${{ steps.version.outputs.version }}
            org.opencontainers.image.revision=${{ steps.version.outputs.commit }}
            org.opencontainers.image.source=https://github.com/${{ github.repository }}
            org.opencontainers.image.title=Emergent CLI
            org.opencontainers.image.description=Command-line interface for Emergent Knowledge Base
          platforms: linux/arm64

      - name: Create and push multi-arch manifest
        run: |
          # Create manifest list combining both architectures
          docker buildx imagetools create -t ghcr.io/${{ steps.version.outputs.owner_lc }}/emergent-cli:${{ steps.version.outputs.version }} \
            ghcr.io/${{ steps.version.outputs.owner_lc }}/emergent-cli:${{ steps.version.outputs.version }}-amd64 \
            ghcr.io/${{ steps.version.outputs.owner_lc }}/emergent-cli:${{ steps.version.outputs.version }}-arm64

          # Also tag as latest
          docker buildx imagetools create -t ghcr.io/${{ steps.version.outputs.owner_lc }}/emergent-cli:latest \
            ghcr.io/${{ steps.version.outputs.owner_lc }}/emergent-cli:${{ steps.version.outputs.version }}-amd64 \
            ghcr.io/${{ steps.version.outputs.owner_lc }}/emergent-cli:${{ steps.version.outputs.version }}-arm64
