name: Go SDK CI

on:
  push:
    branches: [master, main]
    paths:
      - 'apps/server-go/pkg/sdk/**'
      - '.github/workflows/server-go-sdk.yml'
    tags:
      - 'v*'
  pull_request:
    branches: [master, main]
    paths:
      - 'apps/server-go/pkg/sdk/**'
      - '.github/workflows/server-go-sdk.yml'
  workflow_dispatch:

env:
  GO_VERSION: '1.24'

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    if: "!startsWith(github.ref, 'refs/tags/')"
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache-dependency-path: apps/server-go/pkg/sdk/go.sum

      - name: golangci-lint
        uses: golangci/golangci-lint-action@v6
        with:
          version: latest
          working-directory: apps/server-go/pkg/sdk

  test:
    name: Test
    runs-on: ubuntu-latest
    if: "!startsWith(github.ref, 'refs/tags/')"
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache-dependency-path: apps/server-go/pkg/sdk/go.sum

      - name: Run tests
        working-directory: apps/server-go/pkg/sdk
        run: go test -v -race -coverprofile=coverage.out -covermode=atomic ./...

      - name: Upload coverage
        uses: codecov/codecov-action@v4
        with:
          files: apps/server-go/pkg/sdk/coverage.out
          flags: go-sdk
          fail_ci_if_error: false

  build-examples:
    name: Build Examples
    runs-on: ubuntu-latest
    needs: [lint, test]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache-dependency-path: apps/server-go/pkg/sdk/go.sum

      - name: Build basic example
        working-directory: apps/server-go/pkg/sdk/examples/basic
        run: go build -o basic .

      - name: Build documents example
        working-directory: apps/server-go/pkg/sdk/examples/documents
        run: go build -o documents .

      - name: Build search example
        working-directory: apps/server-go/pkg/sdk/examples/search
        run: go build -o search .

      - name: Build projects example
        working-directory: apps/server-go/pkg/sdk/examples/projects
        run: go build -o projects .

  release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Create SDK module tag
        run: |
          SDK_TAG="apps/server-go/pkg/sdk/${GITHUB_REF#refs/tags/}"
          echo "Creating SDK module tag: $SDK_TAG"
          git tag "$SDK_TAG"
          git push origin "$SDK_TAG"

      - name: Extract version
        id: version
        run: echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Get previous tag
        id: prev_tag
        run: |
          PREV_TAG=$(git tag --sort=-version:refname | grep "^v" | head -2 | tail -1 || echo "")
          if [ -z "$PREV_TAG" ] || [ "$PREV_TAG" = "${{ github.ref_name }}" ]; then
            # First release or no previous tag
            PREV_TAG=$(git rev-list --max-parents=0 HEAD | head -1)
          fi
          echo "tag=$PREV_TAG" >> $GITHUB_OUTPUT
          echo "Previous tag: $PREV_TAG"

      - name: Get commit messages for changelog
        id: commits
        run: |
          echo "commits<<EOF" >> $GITHUB_OUTPUT
          git log ${{ steps.prev_tag.outputs.tag }}..${{ github.ref_name }} --pretty=format:"- %s (%h)" -- apps/server-go/pkg/sdk/ >> $GITHUB_OUTPUT || echo "- Initial release" >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Generate changelog
        id: changelog
        uses: actions/github-script@v7
        with:
          script: |
            const commits = `${{ steps.commits.outputs.commits }}`;
            const version = '${{ steps.version.outputs.version }}';

            // Generate a structured changelog from commits
            const lines = commits.split('\n').filter(l => l.trim());

            let features = [];
            let fixes = [];
            let other = [];

            for (const line of lines) {
              const lower = line.toLowerCase();
              if (lower.includes('feat') || lower.includes('add') || lower.includes('new')) {
                features.push(line);
              } else if (lower.includes('fix') || lower.includes('bug') || lower.includes('patch')) {
                fixes.push(line);
              } else {
                other.push(line);
              }
            }

            let changelog = '';
            if (features.length > 0) {
              changelog += '### âœ¨ Features\n' + features.join('\n') + '\n\n';
            }
            if (fixes.length > 0) {
              changelog += '### ðŸ› Bug Fixes\n' + fixes.join('\n') + '\n\n';
            }
            if (other.length > 0) {
              changelog += '### ðŸ“¦ Other Changes\n' + other.join('\n') + '\n\n';
            }

            if (!changelog) {
              changelog = '### ðŸš€ Initial Release\n\nFirst public release of the Emergent Go SDK.\n\n';
            }

            core.setOutput('changelog', changelog);

      - name: Generate release notes
        id: notes
        run: |
          cat > release_notes.md << 'EOF'
          # Emergent Go SDK ${{ steps.version.outputs.version }}

          ${{ steps.changelog.outputs.changelog }}

          ## Installation

          ### Go Module
          ```bash
          go get github.com/emergent-company/emergent/apps/server-go/pkg/sdk@${{ github.ref_name }}
          ```

          ### Import in your code
          ```go
          import "github.com/emergent-company/emergent/apps/server-go/pkg/sdk"
          ```

          ## Quick Start

          ### Basic Usage
          ```go
          package main

          import (
              "context"
              "fmt"
              "log"

              "github.com/emergent-company/emergent/apps/server-go/pkg/sdk"
          )

          func main() {
              // API Key Authentication
              client := sdk.NewClient("https://api.emergent.example.com", 
                  sdk.WithAPIKey("your-api-key"))

              // List projects
              projects, err := client.Projects().List(context.Background())
              if err != nil {
                  log.Fatal(err)
              }
              fmt.Printf("Found %d projects\n", len(projects))
          }
          ```

          ### OAuth Device Flow (for CLI tools)
          ```go
          client := sdk.NewClient("https://api.emergent.example.com",
              sdk.WithDeviceFlow(
                  "client-id",
                  "https://auth.emergent.example.com",
              ))
          ```

          ## Features

          - âœ… API Key and OAuth Device Flow authentication
          - âœ… Full CRUD operations for Documents, Chunks, Projects, Organizations
          - âœ… Vector and hybrid search capabilities
          - âœ… Graph database operations (objects, relationships)
          - âœ… Chat conversation management with streaming
          - âœ… MCP (Model Context Protocol) integration
          - âœ… Multi-tenancy support (organization and project scoping)
          - âœ… Comprehensive error handling and retry logic
          - âœ… Complete test coverage with examples

          ## Documentation

          - [SDK README](https://github.com/${{ github.repository }}/blob/main/apps/server-go/pkg/sdk/README.md)
          - [API Documentation](https://pkg.go.dev/github.com/emergent-company/emergent/apps/server-go/pkg/sdk@${{ github.ref_name }})
          - [Examples](https://github.com/${{ github.repository }}/tree/main/apps/server-go/pkg/sdk/examples)

          ## Service Clients

          | Service | Description |
          |---------|-------------|
          | Documents | Upload, retrieve, update, and delete documents |
          | Chunks | Manage document chunks with embeddings |
          | Search | Vector, lexical, and hybrid search |
          | Graph Objects | Create and manage typed graph entities |
          | Graph Relationships | Link entities with typed relationships |
          | Chat | Create conversations and stream responses |
          | Projects | Manage knowledge base projects |
          | Organizations | Manage organizations |
          | Users | User profile operations |
          | API Tokens | Manage API authentication tokens |
          | Health | Service health checks |
          | MCP | Model Context Protocol operations |

          ## Requirements

          - Go 1.24 or later
          - Emergent API server v0.4.x or later

          ## Support

          - Report issues: https://github.com/${{ github.repository }}/issues
          - Documentation: https://github.com/${{ github.repository }}/tree/main/apps/server-go/pkg/sdk
          EOF

      - name: Create release
        uses: softprops/action-gh-release@v2
        with:
          name: Go SDK ${{ steps.version.outputs.version }}
          body_path: release_notes.md
          draft: false
          prerelease: false
          generate_release_notes: false
