services:
  # Whisper Audio Transcription Service
  # Based on openai-whisper-asr-webservice (https://github.com/onerahmet/openai-whisper-asr-webservice)
  # Downloads model on first start (~150MB for base, ~1.5GB for large-v3)
  whisper:
    image: onerahmet/openai-whisper-asr-webservice:latest
    container_name: emergent-whisper
    restart: unless-stopped
    ports:
      - '${WHISPER_PORT:-9876}:9000'
    environment:
      ASR_MODEL: ${WHISPER_MODEL:-base}
      ASR_ENGINE: ${WHISPER_ENGINE:-openai_whisper}
    volumes:
      - whisper_cache:/root/.cache/whisper
    healthcheck:
      test:
        [
          'CMD-SHELL',
          'curl -s -o /dev/null -w "%{http_code}" http://localhost:9000/asr | grep -qE "405|422"',
        ]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 120s
    deploy:
      resources:
        limits:
          memory: 4G
        reservations:
          memory: 1G

  # PostgreSQL Database with pgvector extension
  db:
    build:
      context: ./docker
      dockerfile: Dockerfile.postgres
    environment:
      # These are sourced from Infisical but need to be set for pg_isready healthcheck
      # The actual values will come from Infisical at runtime
      POSTGRES_USER: ${POSTGRES_USER:-spec}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-spec}
      POSTGRES_DB: ${POSTGRES_DB:-spec}
    command:
      - postgres
      - -c
      - log_destination=stderr
      - -c
      - logging_collector=on
      - -c
      - log_directory=/var/log/postgresql
      - -c
      - log_filename=postgresql-%Y-%m-%d.log
      - -c
      - log_rotation_age=1d
      - -c
      - log_truncate_on_rotation=on
      - -c
      - log_statement=none
      - -c
      - log_connections=on
      - -c
      - log_disconnections=on
      - -c
      - log_duration=off
      - -c
      - log_line_prefix=%t [%p] %u@%d
    ports:
      # Bind to localhost only for security
      - '127.0.0.1:${POSTGRES_PORT:-5432}:5432'
    volumes:
      - pg_data:/var/lib/postgresql/data
      - ${DB_LOGS_PATH:-./docker/logs}:/var/log/postgresql
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -U spec -d spec']
      interval: 5s
      timeout: 5s
      retries: 10

  # NOTE: Zitadel is now deployed independently in ../emergent-infra/zitadel/
  # See ../emergent-infra/zitadel/README.md for setup instructions

  # ──────────────────────────────────────────────────────────────────────
  # Agent Workspace Infrastructure (requires ENABLE_AGENT_WORKSPACES=true)
  # ──────────────────────────────────────────────────────────────────────

  # Firecracker MicroVM Manager (DISABLED by default — requires KVM)
  #
  # Manages Firecracker microVMs for agent workspaces with hardware-level
  # isolation. Requires the host to have /dev/kvm available (bare-metal or
  # nested virtualization enabled). Uncomment to enable.
  #
  # To build: docker compose build firecracker-manager
  # To enable: uncomment the service block and the firecracker_data volume below
  #
  # firecracker-manager:
  #   build:
  #     context: .
  #     dockerfile: deploy/firecracker/Dockerfile
  #   image: emergent/firecracker-manager:latest
  #   container_name: emergent-firecracker-manager
  #   restart: unless-stopped
  #   privileged: true
  #   environment:
  #     FIRECRACKER_BIN: /usr/local/bin/firecracker
  #     FIRECRACKER_KERNEL: /var/lib/firecracker/vmlinux
  #     FIRECRACKER_ROOTFS: /var/lib/firecracker/rootfs.ext4
  #     FIRECRACKER_DATA_DIR: /var/lib/firecracker/data
  #     FIRECRACKER_MAX_VMS: ${FIRECRACKER_MAX_VMS:-10}
  #     FIRECRACKER_DEFAULT_VCPUS: ${FIRECRACKER_DEFAULT_VCPUS:-2}
  #     FIRECRACKER_DEFAULT_MEM_MB: ${FIRECRACKER_DEFAULT_MEM_MB:-512}
  #     LOG_LEVEL: ${LOG_LEVEL:-info}
  #   volumes:
  #     - /dev/kvm:/dev/kvm
  #     - firecracker_data:/var/lib/firecracker/data
  #   networks:
  #     workspace_net:
  #       ipv4_address: 172.30.0.10
  #   deploy:
  #     resources:
  #       limits:
  #         memory: 1G
  #       reservations:
  #         memory: 256M
  #   healthcheck:
  #     test: ["CMD", "firecracker", "--version"]
  #     interval: 30s
  #     timeout: 10s
  #     retries: 3

volumes:
  pg_data:
  whisper_cache:
    driver: local
  # Persistent storage for agent workspace container volumes (gVisor/Docker)
  workspace_volumes:
    driver: local
  # Persistent storage for Firecracker microVM block devices (uncomment with firecracker-manager)
  # firecracker_data:
  #   driver: local

# Isolated network for agent workspace containers
# Restricts inter-container communication — workspaces cannot reach
# infrastructure services (db, zitadel) directly. The server bridges
# requests between the main network and the workspace network.
networks:
  workspace_net:
    driver: bridge
    ipam:
      config:
        - subnet: 172.30.0.0/24
          gateway: 172.30.0.1
    internal: false # Allow outbound internet (for git clone, package install)
    driver_opts:
      com.docker.network.bridge.enable_icc: 'false' # Disable inter-container communication
